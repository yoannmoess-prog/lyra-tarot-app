/* src/Page4.css — final grid 3 cartes, chat, VOUS+CTA simplifiés */

/* Fades */
.fade-in  { opacity: 1; transition: opacity .6s ease; }
.fade-out { opacity: 0; transition: opacity .6s ease; }
.fade-in-soft  { opacity: 1; transform: translateY(0) scale(1); transition: opacity .6s ease, transform .6s ease; }
.fade-out-soft { opacity: 0; transform: translateY(6px) scale(.985); transition: opacity .55s ease, transform .55s ease; }
.pre-fade { opacity: 0; transform: translateY(6px) scale(.985); }

/* Titre fixe pendant le tirage */
.p4-fixed-title{
  position: fixed;
  top: clamp(10px, 3vh, 32px);
  left: 0; right: 0;
  text-align: center;
  z-index: 3;
  pointer-events: none;
  font-family:'Sorts Mill Goudy', serif;
  color:#F8F5E1;
  font-size: clamp(1.6rem, 3vw, 2.4rem);
  line-height:1.25;
  padding: 0 4vw;
  opacity: 0;
}
.title-reveal{ animation: titleFade .6s ease forwards; }
@keyframes titleFade{
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Instructions */
.p4-fixed-instructions{
  position: fixed;
  top: calc(clamp(10px, 3vh, 32px) + clamp(32px, 7vh, 96px));
  left: 0; right: 0;
  text-align: center;
  z-index: 2;
  pointer-events: none;
  padding: 0 4vw;
  opacity: 0;
}
.instr-reveal{ animation: instrFade .5s ease .1s forwards; }
@keyframes instrFade{
  from { opacity: 0; transform: translateY(-4px); }
  to   { opacity: 1; transform: translateY(0); }
}
.p4-instruction{
  font-family:'Sorts Mill Goudy', serif;
  color:#F8F5E1;
  font-size: clamp(1.05rem, 1.7vw, 1.5rem);
  opacity:.95;
  margin:0;
}

/* Décalage sous le titre + instructions */
.with-title-offset{
  --top-fixed: calc(
    clamp(56px, 12vh, 120px) +
    clamp(24px, 6vh, 64px)
  );
  padding-top: var(--top-fixed);
}
.with-title-only{ --top-fixed: clamp(56px, 12vh, 120px); }

/* Root */
.page4-root{ overscroll-behavior-y: contain; min-height: 100vh; }
@supports (height: 100svh){ .page4-root{ min-height: 100svh; } }

/* Board (deck + slots) */
.page4-wrap{
  min-height: calc(100vh - var(--top-fixed, 0px) - max(env(safe-area-inset-bottom), var(--kb, 0px)));
  display:flex; flex-direction: column;
  align-items:center; justify-content:center;
  gap: clamp(18px, 4vh, 36px);
  text-align:center; padding: 6vh 4vw;
}
@supports (height: 100lvh){
  .page4-wrap{ min-height: calc(100lvh - var(--top-fixed, 0px) - max(env(safe-area-inset-bottom), var(--kb, 0px))); }
}
.board-shell{ will-change: opacity, transform; }

/* Fade-out 2s du board (rail+deck) */
.board-shell.fade-out-2s{ opacity: 0; transition: opacity 2s ease; }

.board{
  margin: 0 auto;
  display:flex; align-items:center; justify-content:center;
  gap:clamp(22px, 4vw, 64px);
  width:100%; max-width: min(1100px, 94vw);
}
.board.col{ flex-direction: column; }

.deck-block{ display:flex; flex-direction: column; align-items:center; gap: clamp(18px, 4vh, 36px); }

/* Deck */
.deck-area{
  position:relative;
  width: min(16vw, 21vh, 160px);
  aspect-ratio: 9.27 / 16;
  height:auto;
  cursor:pointer; user-select:none;
  touch-action: none;
  -webkit-tap-highlight-color: transparent;
}
.deck-area:focus { outline: none; }
.deck-area:focus-visible{
  outline: 2px solid rgba(248,245,225,.85);
  outline-offset: 4px; border-radius: 14px;
}

/* Cartes génériques */
.card{
  position:absolute; inset:0;
  border-radius:14px;
  box-shadow:0 8px 18px rgba(0,0,0,.33);
  transform-origin:50% 70%;
  background-size: cover; background-position: center; background-repeat: no-repeat;
  will-change: transform;
}
.card-back{
  background-image: url("./assets/desk_01.png");
  background-size: 110% 110%;
  background-position: center;
}

/* Shuffle zen (ombre douce) */
.ghost{ pointer-events:none; opacity:1; border-radius:14px; }
.shuffling .stack{
  animation: riffleLoop 1700ms ease-in-out infinite;
  box-shadow: 0 6px 14px rgba(0,0,0,.22);
}
.shuffling .stack:nth-last-child(1){ animation-duration: 1700ms;  animation-delay: -260ms; }
.shuffling .stack:nth-last-child(2){ animation-duration: 1900ms;  animation-delay: -420ms; }
.shuffling .stack:nth-last-child(3){ animation-duration: 2100ms;  animation-delay: -580ms; }
.shuffling .stack:nth-last-child(4){ animation-duration: 2300ms;  animation-delay: -740ms; }

@keyframes riffleLoop{
  0%   { transform: translate(0,0) rotate(0) scale(1.000); }
  25%  { transform: translate(8px,10px) rotate(8deg) scale(1.018); }
  50%  { transform: translate(0,2px) rotate(.2deg) scale(1.004); }
  75%  { transform: translate(-8px,-8px) rotate(-7deg) scale(1.016); }
  100% { transform: translate(0,0) rotate(0) scale(1.000); }
}

/* Rail des cartes tirées */
.chosen-rail{
  display:flex; flex-direction: row; align-items:center; justify-content:center;
  gap:clamp(12px, 2.4vw, 26px);
  min-height: min(20vh, 220px);
}
.slot-wrap{ position: relative; width: min(12vw, 16vh, 120px); aspect-ratio: 9.27 / 16; height:auto; }
.slot-ghost{
  position:absolute; inset:0; border-radius:12px;
  border: 2px dashed rgba(248,245,225,.35);
  background: rgba(248,245,225,.06);
}
.chosen{
  position:absolute; inset:0; opacity:0; transform: translateY(8px) scale(.98);
  border-radius:12px; animation: appear .35s ease forwards;
}
@keyframes appear{ to { opacity:1; transform: translateY(0) scale(1); } }
.chosen.pop{
  animation: appear .35s ease forwards, popGlow .42s ease-out;
  box-shadow: 0 0 0 rgba(255,255,255,0);
}
@keyframes popGlow{
  0%   { transform: translateY(0) scale(1.00); box-shadow: 0 0 0 rgba(255,255,255,0); }
  35%  { transform: translateY(-2px) scale(1.06); box-shadow: 0 0 22px rgba(255,255,255,.65); }
  100% { transform: translateY(0) scale(1.00); box-shadow: 0 0 0 rgba(255,255,255,0); }
}

/* --- Bloc final défilant --- */
.final-stack{
  max-width: min(1100px, 94vw);
  margin: 0 auto;
  padding: 6vh clamp(16px,4vw,56px) 8vh;
  display: grid;
  gap: clamp(18px, 3.5vw, 28px);
}

.flow-title{
  font-family:'Sorts Mill Goudy', serif;
  color:#F8F5E1;
  font-size: clamp(1.6rem, 3vw, 2.2rem);
  margin: 0 auto;
  text-align: center;
}

/* Cartes finales — GRID 3 pour ne jamais se toucher */
.final-hero{
  display:flex; align-items:center; justify-content:center;
  text-align:center;
}
.final-rail{
  width: 100%;
  display:grid; grid-template-columns: repeat(3, minmax(0, 1fr));
  justify-items: center; align-items: start;
  gap: clamp(16px, 3.4vw, 32px);
  opacity: 0;
}

/* Apparition lente (2s) des 3 grandes cartes */
.appear-slow{ animation: finalAppear 2s ease forwards; }
@keyframes finalAppear{ from { opacity: 0; transform: scale(.985); } to { opacity: 1; transform: scale(1); } }

/* Glow héroïque après flips */
.final-rail.sealed .final-card-flip .final-front{
  animation: cardGlowHero .95s ease-out both;
}
@keyframes cardGlowHero{
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
  35%  { box-shadow: 0 0 90px rgba(255,255,255,0.98); filter: drop-shadow(0 0 62px rgba(255,255,255,0.98)); }
  100% { box-shadow: 0 14px 34px rgba(0,0,0,.58); filter: none; }
}

/* Taille constante dos/face + responsive safe */
.final-card-outer{
  width: min(28vw, 26vh, 200px);
  aspect-ratio: 9.27 / 16; perspective: 1100px;
  justify-self: center;
}
.final-card-flip{
  position: relative; width: 100%; height: 100%;
  transform-style: preserve-3d; transition: transform .62s cubic-bezier(.2,.7,.2,1);
}
.final-card-flip.is-flipped{ transform: rotateY(180deg); }
.final-face{
  position:absolute; inset:0; border-radius:14px; backface-visibility:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,.33); background-size:cover; background-position:center; background-repeat:no-repeat;
}
.final-back{ background-image: url("./assets/desk_01.png"); background-size:110% 110%; }
.final-front{
  transform: rotateY(180deg);
  display:flex; align-items:center; justify-content:center;
  background: rgba(15,15,15,.18);
  border: 1px solid rgba(248,245,225,.12);
  position: relative; overflow: hidden;
}
.final-front > img{
  width: 100%; height: 100%;
  object-fit: cover; display:block;
  border-radius: inherit;
}
.final-front::before{
  content:""; position:absolute; inset:-10%;
  background: linear-gradient(100deg, rgba(255,255,255,.12), rgba(255,255,255,0) 60%);
  transform: translateX(-120%) skewX(-12deg); filter: blur(1px);
}
.final-card-flip.is-flipped .final-front::before{ animation: foldSweep .62s cubic-bezier(.2,.7,.2,1) both; }
@keyframes foldSweep{
  0%   { transform: translateX(-120%) skewX(-12deg); opacity:.85; }
  55%  { transform: translateX(0%)    skewX(-12deg); opacity:.35; }
  100% { transform: translateX(120%)  skewX(-12deg); opacity:0; }
}

/* Légendes sous les cartes */
.final-caption{
  margin-top: clamp(26px, 4vh, 36px);
  padding-top: 2px;
  font-family:'Sorts Mill Goudy', serif;
  color:#F8F5E1;
  opacity: 0;
  transform: translateY(-2px);
  transition: opacity .35s ease .15s, transform .35s ease .15s;
  pointer-events: none;
}
.final-card-flip.is-flipped + .final-caption{
  opacity: 1;
  transform: translateY(0);
}

/* --- Chat : alignements fermes à gauche/droite --- */
.chat-wrap{
  width: 100%;
  max-width: min(900px, 92vw);
  margin: 0 auto;
  padding: 12px 8px max(env(safe-area-inset-bottom), 40px);
  display:flex; flex-direction: column; gap: 10px;
  opacity: 0; transform: translateY(8px);
  transition: opacity .5s ease, transform .5s ease;
  text-align: left;
  align-items: flex-start;
}
.chat-wrap.show{ opacity: 1; transform: translateY(0); }

.bubble{
  max-width: 78%;
  padding: 10px 14px;
  border-radius: 18px;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  line-height: 1.35;
  position: relative;
  color: #101112;
  background: #E9EDF2;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 2px 10px rgba(0,0,0,.12);
  text-align: left;
}
.bubble .who{
  font-weight: 800; letter-spacing:.06em; text-transform: uppercase;
  margin: 0 0 4px; font-size: .78rem; opacity: .7;
}

/* Coins demandés */
.bubble.lyra{
  align-self: flex-start;
  border-top-left-radius: 0;
}

/* IMPORTANT : ne pas masquer globalement toutes les bulles VOUS */
.bubble.you{
  align-self: flex-end;
  border-top-right-radius: 0;
  overflow: hidden;
}

/* Bloc commun VOUS + CTA (apparition ensemble, disparition instant) */
.you-block{
  align-self: flex-end;
  max-width: 78%;
  width: 100%;
   display: flex;
  flex-direction: column;
  gap: 8px;
  opacity: 0;
  transform: translateY(6px);
  /* pas de transition ici -> hide instantané */
}

/* Tous les enfants du bloc doivent prendre 100% de sa largeur */
.you-block > *{
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.you-block.show{
  opacity: 1;
  transform: translateY(0);
  transition: opacity 600ms ease, transform 600ms ease; /* fade-in à l’apparition */
}

/* La bulle VOUS occupe 100% de la largeur du bloc */
.you-block .bubble.you{
  width: 100%;
  max-width: 100%;
}

/* Le CTA occupe aussi 100% et a le même “ressenti” de largeur */
.you-block .newdraw-btn{
  display: block;               /* important pour remplir la largeur */
  width: 100%;
  padding: 10px 14px;           /* même padding horizontal que .bubble */
  border-radius: 18px;          /* même galbe que la bulle */
  border: 1px solid rgba(248,245,225,.6);
  background: transparent;      /* fond 0% d’opacité */
  color: rgba(248,245,225,.6);  /* texte clair à 60% */
  font: 400 0.95rem/1.1 "Sorts Mill Goudy", serif;  /* pas gras + même fonte */
  text-align: left;             /* cohérent avec le texte des bulles */
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,.12); /* même densité visuelle que bulle */
}

/* VOUS (input) */
.you-form{
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
}
.you-input{
  flex: 1 1 auto;
  min-width: 0;
  width: 100%;
  box-sizing: border-box;
  font-family:'Sorts Mill Goudy', serif !important;
  font-weight: 400;
  font-size: 1rem;
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 12px;
  padding: 10px 12px;
  outline: none;
  background: #fff;
  color: #111;
  padding-right: 46px;
}

/* Pas d’animation de sortie quand la bulle "..." arrive */
.you-block.hide{
  display: none;
}

.you-input::placeholder{
  color: #666;
  font-family:'Sorts Mill Goudy', serif !important;
  font-weight: 400;
}

/* Bouton Send — zéro contour/fond + centrage vertical */
.send-btn{
  position: absolute;
  right: 8px; top: 50%;
  transform: translateY(-50%);
  width: 36px; height: 36px;
  display: inline-flex; align-items: center; justify-content: center;
  padding: 0; margin: 0;
  border: 0; background: transparent; box-shadow: none; outline: none;
  -webkit-appearance: none; appearance: none;
  cursor: pointer;
  color: #111;
}
.send-btn:focus, .send-btn:focus-visible{ outline: none; box-shadow: none; }
.send-btn .material-symbols-outlined{ font-size: 22px; line-height: 1; display: block; }

/* CTA : même largeur que la bulle VOUS, aligné, fond transparent, 60% opacité */
.newdraw-btn{
  display: block;
  width: 100%;
  margin-top: 10px;
  padding: 10px 14px;
  border-radius: 9999px;
  background: transparent;
  border: 1px solid rgba(248,245,225,.6);
  color: rgba(248,245,225,.6);
  font: 400 0.8rem/1.1 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  text-align: center;
  box-shadow: none;
  cursor: pointer;
}
.newdraw-btn:focus,
.newdraw-btn:focus-visible{
  outline: none;
  box-shadow: 0 0 0 2px rgba(248,245,225,.55);
}

/* Police dans les bulles (fix “font qui lâche”) */
.bubble .msg p{
  font-family: 'Sorts Mill Goudy', serif !important;
  font-weight: 400;
}

/* Bulle "LYRA tape…" (trois points animés) */
.bubble.typing{
  align-self: flex-start;
}
.dots{
  display: inline-flex;
  gap: 6px;
  padding: 4px 2px 2px 2px;
}
.dots span{
  width: 6px; height: 6px; border-radius: 50%;
  background: #333;
  opacity: .2;
  animation: dotBlink 1.2s infinite ease-in-out;
}
.dots span:nth-child(2){ animation-delay: .2s; }
.dots span:nth-child(3){ animation-delay: .4s; }
@keyframes dotBlink{
  0%, 20% { opacity: .2; transform: translateY(0); }
  50%     { opacity: 1;  transform: translateY(-2px); }
  100%    { opacity: .2; transform: translateY(0); }
}

/* Vol physique */
.fly-phys{
  position: fixed; z-index: 5; pointer-events: none;
  animation: flyPhys 600ms cubic-bezier(.2,.7,.2,1) forwards;
  transform-origin: 50% 50%; perspective: 1000px;
}
@keyframes flyPhys{
  0%   { transform: translate(0,0) scale(1) rotateY(0deg); opacity: 1; }
  20%  { transform: translate(calc(var(--dx)*.2), calc(var(--dy)*.2)) scale(calc(1 + (var(--scale) - 1)*.2)) rotateY(12deg); opacity: 1; }
  85%  { transform: translate(var(--dx), var(--dy)) scale(var(--scale)) rotateY(0deg); opacity: 1; }
  100% { transform: translate(var(--dx), var(--dy)) scale(var(--scale)) rotateY(0deg); opacity: 0.999; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  * { animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; }
  .shuffling .stack { animation: none !important; }
  .fly-phys { animation: none !important; opacity: 0; }
}

/* Mobile */
@media (max-width:520px){
  .with-title-offset{ padding-top: var(--top-fixed); }
  .deck-area{ width:min(28vw, 22vh, 150px); }
  .final-card-outer{ width:min(30vw, 26vh, 156px); }
}

/* Lightbox: contour à 0% (si présent dans ton CSS) */
.lb-frame{ border: none !important; }